---
title: "Week 11 Slides"
subtitle: "Mapping, Part 1"
author: "**Isabella Velásquez and Maryrose Weatherton**"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output: xaringan::moon_reader
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = "center")

library(dplyr)

elsi_data <-
    readr::read_csv(
        "https://github.com/utkeds/f23-founds-eds/blob/main/data/ELSI_csv_export_6383262475806903427192.csv?raw=true",
        skip = 6
    ) %>% janitor::clean_names()
```

```{r, echo=FALSE}
# then load all the relevant packages
pacman::p_load(pacman, knitr, tidyverse, readxl)
```

```{r xaringanExtra-clipboard, echo=FALSE}
# these allow any code snippets to be copied to the clipboard so they 
# can be pasted easily
htmltools::tagList(
    xaringanExtra::use_clipboard(button_text = "<i class=\"fa fa-clipboard\"></i>",
                                 success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",),
    rmarkdown::html_dependency_font_awesome()
)
```

```{r xaringan-panelset, echo=FALSE}
xaringanExtra::use_panelset()
```

# Purpose and Agenda

One of the most important aspects of working with geographical data is the presentation and communication of the results. In this lesson, we'll explore how to make stunning and informative maps that can help you convey insights about data in a visually appealing way.

## What we'll do in this presentation

- Final project comments & recommendations
- Revisit Key Concepts from Assignment 9
- Mapping with ggplot2
- Adding data to maps

---

## Final project

* Please review the comments on your final projects and follow up if necessary
* If you do not have the data, please obtain it as soon as possible (really only a month left!)
* Please start data cleaning as soon as possible
* Involve your PI/collaborators

```{r}
#| echo: false
#| out.width: 60%
#| fig-align: center
knitr::include_graphics("https://media0.giphy.com/media/s4kpsTSwoiFCU/giphy.gif")
```


---

## Revisit Key Concepts from Assignment 9

**Why may you not want to do this?**

```{r}
#| echo: true
glimpse(elsi_data %>% select(state_name_public_school_latest_available_year))
```


```{r}
#| echo: true
elsi_data <- elsi_data %>% 
    mutate(state_name_public_school_2021_22 =
               as.double(state_name_public_school_2021_22))
```

---

## Revisit Key Concepts from Assignment 9

**How would you interpret this?**

A. The largest average number of students in schools was 1240.

B. The largest average number of students in districts was 1240.

```{r}
#| echo: true
elsi_data %>%
    group_by(agency_id_nces_assigned_public_school_latest_available_year) %>% 
    summarize(mean = mean(total_students_all_grades_excludes_ae_public_school_2021_22)) %>%
    arrange(desc(mean)) %>% head()
```

---

## Revisit Key Concepts from Assignment 9

**Why don't the number of rows change?**

```{r}
#| echo: true
elsi_data %>% nrow()
```

```{r}
#| echo: true
elsi_data %>% 
    group_by(school_name) %>% 
    nrow()
```

---

## Revisit Key Concepts from Assignment 9

**Why would you not want to group by `state_name_public_school_latest_available_year`?**

```{r}
#| echo: true
table(elsi_data$state_name_public_school_latest_available_year)
```

---

## Key Concept: Mapping with ggplot2

There are many ways of mapping with R. Today, we'll focus on mapping with ggplot2.

---

## The maps package

- The maps package contains many outlines of continents, countries, states, and counties.
- To use maps, run the following:

```{{r}}
install.packages("maps")
```

- If you want even more outlines, you can download the mapdata package

---

## The maps package

.panelset[
.panel[.panel-name[Introduction]

ggplot2 operates on data frames. Therefore we need some way to translate the maps data into a data frame format the ggplot can use.
]

.panel[.panel-name[Maps data]

```{r}
#| echo: true
#| eval: false
world_map <- map_data("world")
head(world_map)
```

]

.panel[.panel-name[Structure of the maps data]

```{r}
#| echo: false
#| eval: true
world_map <- map_data("world")
head(world_map)
```

- `long` is longitude. Things to the west of the prime meridian are negative.
- `lat` is latitude.
- `order` shows in which order ggplot should "connect the dots"
- `region` and `subregion` tell what region or subregion a set of points surrounds.
- `group` controls (among other things) whether adjacent points should be connected by lines. If they are in the same group, then they get connected, but if they are in different groups then they don’t.
    - Having points in different groups means that ggplot "lifts the pen" when going between them.

]
]

---

## Make a map with ggplot2

.panelset[
.panel[.panel-name[World map code]

Plot the world with:

```{r}
#| echo: true
#| eval: false
ggplot(data = world_map) +
  geom_map(map = world_map,
           aes(x = long,
               y = lat,
               map_id = region)) +
    coord_fixed(1.3)
```

]

.panel[.panel-name[World map]

```{r}
#| echo: false
#| eval: true
ggplot(data = world_map) +
  geom_map(map = world_map,
           aes(x = long,
               y = lat,
               map_id = region)) +
    coord_fixed(1.3)
```

]

.panel[.panel-name[Why `coord_fixed()`?]

Why `coord_fixed()`? It fixes the relationship between one unit in the y direction and one unit in the x direction. If you change the outer dimensions of the plot (i.e., by changing the window size or the size of the PDF file you are saving it to), the aspect ratio remains unchanged.

```{r}
#| echo: true
#| eval: false
ggplot(data = world_map) +
  geom_map(map = world_map,
           aes(x = long,
               y = lat,
               map_id = region)) +
    coord_fixed(1.3)
```

]
]

---

## Make a map with ggplot2

Since this is ggplot2, you can customize your graph the same way as any ggplot2 object.

.panelset[
.panel[.panel-name[Customization]

```{r}
#| echo: true
#| eval: false
ggplot(data = world_map) +
  geom_map(map = world_map,
           aes(x = long,
               y = lat,
               map_id = region),
           fill = "white", 
           size = 1,
           color = "blue") +
    coord_fixed(1.3)
```

]

.panel[.panel-name[Printed map]

```{r}
#| echo: false
#| eval: true
ggplot(data = world_map) +
  geom_map(map = world_map,
           aes(x = long,
               y = lat,
               map_id = region),
           fill = "white", 
           size = 1,
           color = "blue") +
    coord_fixed(1.3)
```
]
]

---

## More maps with maps

```{r}
#| echo: true
usa_map <- map_data("usa")

ggplot(data = usa_map) +
  geom_map(map = usa_map,
           aes(x = long,
               y = lat,
               map_id = region)) +
    coord_fixed(1.3)
```

---

## More maps with maps

```{r}
#| echo: true
state_map <- map_data("state")

ggplot(data = state_map) +
  geom_map(map = state_map,
           aes(x = long,
               y = lat,
               fill = region, # different color for each state
               map_id = region)) +
    coord_fixed(1.3) +
    theme(legend.position = "none") # remove the legend
```

---

## More maps with maps

Since we are working with a dataframe, we can run our usual dplyr functions to get what we need.

.panelset[
.panel[.panel-name[Filter data]
```{r}
#| echo: true
tn_map <-
    state_map %>% 
    filter(region == "tennessee")
```
]

.panel[.panel-name[Create ggplot object]

```{r}
#| echo: true
#| eval: false
ggplot(data = tn_map) +
  geom_map(map = tn_map,
           aes(x = long,
               y = lat,
               map_id = region)) +
    coord_fixed(1.3) +
    theme(legend.position = "none") # remove the legend
```
]

.panel[.panel-name[Print map]
```{r}
#| echo: false
ggplot(data = tn_map) +
  geom_map(map = tn_map,
           aes(x = long,
               y = lat,
               map_id = region)) +
    coord_fixed(1.3) +
    theme(legend.position = "none") # remove the legend
```
]
]
---

## Key Concept: Choropleth maps

Geographical heat maps, also known as choropleth maps, are one way of visualizing our geographic data.

```{r}
#| echo: false
#| out.width: 60%
#| fig-align: center
knitr::include_graphics("~/R/f23-founds-eds/week-11/photo.png")
```

---

## Making choropleth maps: Global map

```{r}
#| include: false
set.seed(123)

regions_data <-
    world_map %>% 
    select(region) %>% 
    distinct() %>% 
    mutate(value = sample(100:1000, n()))
```

```{r}
#| echo: true
head(world_map)
```

```{r}
#| echo: true
head(regions_data)
```

---

## Making choropleth maps: Joining data

```{r}
#| echo: true
joined_data <- left_join(world_map, regions_data, by = "region")

head(joined_data)
```

---

## Making choropleth maps: Joining data

Add the data as an aesthetic in your ggplot object with `fill()`.

.panelset[

.panel[.panel-name[Create choropleth map]

```{r}
#| echo: true
#| eval: false
ggplot(data = joined_data) +
  geom_map(map = joined_data,
           aes(x = long,
               y = lat,
               fill = value,
               map_id = region)) +
    coord_fixed(1.3)
```
]

.panel[.panel-name[Create choropleth map]

```{r}
#| echo: false
#| eval: true
ggplot(data = joined_data) +
  geom_map(map = joined_data,
           aes(x = long,
               y = lat,
               fill = value,
               map_id = region)) +
    coord_fixed(1.3)
```
]
]

---

## Making choropleth maps: U.S. Map

```{r}
#| include: false
set.seed(123)

state_data <-
    state_map %>% 
    select(state = region) %>% 
    distinct() %>% 
    mutate(value = sample(100:1000, n()))
```

```{r}
#| echo: true
head(state_data)
```

```{r}
#| echo: true
joined_data <- left_join(state_map, state_data, join_by("region" == "state"))

head(joined_data)
```

---

## Making choropleth maps: Joining data

```{r}
#| echo: true
ggplot(data = joined_data) +
  geom_map(map = joined_data,
           aes(x = long,
               y = lat,
               fill = value,
               map_id = region)) +
    coord_fixed(1.3)
```

---

## Key Concept: Adding points to a map

Let's say we have another dataset with longitude/latitude data for different points:

```{r}
#| include: false
points_data <-
    tibble::tribble(
               ~Place.Name, ~Latitude,  ~Longitude,
          "Wisconsin, USA",      44.5,       -89.5,
      "West Virginia, USA",        39,       -80.5,
            "Vermont, USA",        44,  -72.699997,
          "Texas, the USA",        31,        -100,
    "South Dakota, the US",      44.5,        -100,
    "Rhode Island, the US", 41.742325,  -71.742332,
          "Oregon, the US",        44,      -120.5,
           "New York, USA",        43,         -75,
      "New Hampshire, USA",        44,       -71.5,
           "Nebraska, USA",      41.5,        -100,
          "Kansas, the US",      38.5,         -98,
        "Mississippi, USA",        33,         -90,
           "Illinois, USA",        40,         -89,
        "Delaware, the US",        39,       -75.5,
        "Connecticut, USA", 41.599998,  -72.699997,
        "Arkansas, the US", 34.799999,  -92.199997,
            "Indiana, USA", 40.273502,  -86.126976,
           "Missouri, USA", 38.573936,   -92.60376,
            "Florida, USA", 27.994402,  -81.760254,
             "Nevada, USA", 39.876019, -117.224121,
          "Maine, the USA", 45.367584,  -68.972168,
           "Michigan, USA", 44.182205,  -84.506836,
        "Georgia, the USA", 33.247875,  -83.441162,
             "Hawaii, USA", 19.741755, -155.844437,
             "Alaska, USA", 66.160507, -153.369141,
          "Tennessee, USA", 35.860119,  -86.660156,
           "Virginia, USA", 37.926868,  -78.024902,
         "New Jersey, USA", 39.833851,  -74.871826,
           "Kentucky, USA", 37.839333,   -84.27002,
       "North Dakota, USA", 47.650589, -100.437012,
          "Minnesota, USA",  46.39241,   -94.63623,
       "Oklahoma, the USA", 36.084621,  -96.921387,
            "Montana, USA",  46.96526, -109.533691,
     "Washington, the USA", 47.751076, -120.740135,
               "Utah, USA",  39.41922, -111.950684,
           "Colorado, USA", 39.113014, -105.358887,
               "Ohio, USA", 40.367474,  -82.996216,
            "Alabama, USA",  32.31823,  -86.902298,
           "Iowa, the USA", 42.032974,  -93.581543,
         "New Mexico, USA", 34.307144, -106.018066,
     "South Carolina, USA", 33.836082,  -81.163727,
       "Pennsylvania, USA", 41.203323,  -77.194527,
            "Arizona, USA", 34.048927, -111.093735,
           "Maryland, USA", 39.045753,  -76.641273,
      "Massachusetts, USA", 42.407211,  -71.382439,
         "California, USA", 36.778259, -119.417931,
              "Idaho, USA", 44.068203, -114.742043,
            "Wyoming, USA",  43.07597, -107.290283,
     "North Carolina, USA", 35.782169,  -80.793457,
          "Louisiana, USA",  30.39183,  -92.329102
    )
```


```{r}
#| echo: true
head(points_data)
```

---

## Key Concept: Adding points to a map

```{r}
#| echo: true
ggplot(data = joined_data) +
  geom_map(map = joined_data,
           aes(x = long,
               y = lat,
               fill = value,
               map_id = region)) +
    coord_fixed(1.3) +
    geom_point(data = points_data,
               aes(x = Longitude, y = Latitude))
```

---

## Code-along

.panelset[

.panel[.panel-name[Dataset]

Data is from iNaturalist

- Can query and download data from Explorer tab: <https://www.inaturalist.org/observations>
- There's also an R API wrapper: <https://cran.r-project.org/web/packages/rinat/rinat.pdf>

]
.panel[.panel-name[Pull world map data]

```{r}
#| eval: false
#| echo: true
library(tidyverse)
library(maps)

world_map <- map_data("world")
```

]

.panel[.panel-name[Read in data]

```{r}
#| eval: false
#| echo: true
bear_dat <- read_csv(here::here("week-11", "data", "bears.csv"))
```

]

.panel[.panel-name[Prep data]

```{r}
#| eval: false
#| echo: true
bear_dat_grouped <-
    bear_dat %>% 
    mutate(place_country_name = case_match(place_country_name,
                                           "United States" ~ "USA",
                                           .default = place_country_name)) %>% 
    group_by(place_country_name) %>% 
    summarize(n_bears = n())
```

]

.panel[.panel-name[Join data]

```{r}
#| eval: false
#| echo: true
bear_map <-
    left_join(world_map, bear_dat_grouped, join_by(region == place_country_name))
```

]
]

---

## Code-along

.panelset[

.panel[.panel-name[Create choropleth data]

```{r}
#| eval: false
#| echo: true
ggplot(data = bear_map) +
    geom_map(map = bear_map,
             aes(
                 x = long,
                 y = lat,
                 fill = n_bears,
                 map_id = region
             )) +
    coord_fixed(1.3)
```

]

.panel[.panel-name[Add points]

```{r}
#| eval: false
#| echo: true
ggplot(data = bear_map) +
    geom_map(map = bear_map,
             aes(
                 x = long,
                 y = lat,
                 fill = n_bears,
                 map_id = region
             )) +
    coord_fixed(1.3) +
    geom_point(data = bear_dat,
               aes(x = longitude, y = latitude,
                   color = common_name),
               alpha = 0.3) +
    theme(legend.position = "none") # remove the legend
```

]
]

---

# What's next?

.panelset[

.panel[.panel-name[Weekly Assignment]

- In this week's assignment, you will create a map that shows global energy data from [Our World in Data](https://ourworldindata.org/energy).
- The dataset is mostly cleaned up as part of the TidyTuesday project, but some preparation steps are still required.
- The reach section asks you to add customization. If there's something you would like to do and have questions on how to do it, please reach out!

]

.panel[.panel-name[Mini-Project]

- The mini-project is now available in Canvas! You will be using recent data from the Tennessee Department of Education. While the data is specified, the analyses you conduct to answer two questions of the data are more open-ended in nature. You'll have one more week to complete this, to allow for time for you to ask questions and dig deep into the data. One pointer - note that many of the variables are at the school-level and represent the percentage of teachers who chose a particular response. How you choose to "wrangle" or prepare the data given the nature of these variables is an important consideration as you work on your mini project. Our goal with this assignment is not perfection, but rather for you to practice capabilities you have developed over the semester. This is reflected in the grading rubric for the assignment!

]

.panel[.panel-name[Optional Substantive Reading(s)]

Substantive reading(s):

> Mann, B., & Saultz, A. (2019). The role of place, geography, and geographic information systems in educational research. Aera Open, 5(3), https://journals.sagepub.com/doi/10.1177/2332858419869340

This is linked in Canvas.

]

.panel[.panel-name[Technical Reading(s)]

- Technical reading(s):

> on mapping

This is also linked in Canvas.

]

]